- name: Install  & config server
  hosts: serv
  vars_files:
   - secrets.yml
  become: true
  tasks:

    - name: Update apt package cache
      ansible.builtin.apt:
       update_cache: true

    - name: Install packages
      ansible.builtin.apt:
       name:
        - borgbackup
       state: present

    - name: 'Create borg group on server'
      ansible.builtin.group:
       name: 'borg'
       system: 'true' 

    - name: 'Create borg user on server'
      ansible.builtin.user:
       name: 'borg'
       group: 'borg'
       shell: '/bin/bash'
       home: '/srv/borg'
       createhome: 'true'
       system: 'yes'
       password: "{{ upassword | password_hash('sha512') }}"

    - name: Create dir
      ansible.builtin.file:
       path: /var/backup
       state: directory
       owner: borg
       group: borg
       mode: "0770"

    - name: Create directory
      ansible.builtin.file:
       path: /srv/borg/.ssh
       state: directory
       mode: "0700"

    - name: Create directory
      ansible.builtin.file:
       path: /srv/borg/.ssh/authorized_keys
       owner: borg
       group: borg
       state: touch
       mode: "0600"
